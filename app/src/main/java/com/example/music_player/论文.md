# Android音乐播放器—期末项目成果演示

## 一、项目概述

### 1.1 业务背景

随着移动互联网的快速发展和智能手机的普及，音乐播放器已成为人们日常生活中不可或缺的应用。传统的音乐播放器功能单一，用户体验较差，无法满足现代用户对个性化、智能化音乐播放的需求。本项目旨在开发一款功能完善、界面美观、用户体验良好的Android音乐播放器应用，为用户提供便捷的音乐播放、管理和个性化服务。

### 1.2 业务需求

本项目需要实现以下核心业务需求：

1. **用户认证系统**：支持用户注册、登录功能，确保用户数据的安全性
2. **音乐播放功能**：支持本地音乐文件的播放、暂停、上一首、下一首等基本操作
3. **播放模式管理**：支持顺序播放、随机播放、单曲循环三种播放模式
4. **音乐管理功能**：支持音乐搜索、收藏、播放历史记录等功能
5. **个性化设置**：支持主题切换、头像管理、个人信息编辑等个性化功能
6. **管理员功能**：支持用户管理、密码重置等管理员操作
7. **用户体验优化**：实现滚动标题、底部播放栏、轮播图等UI组件，提升用户体验

### 1.3 项目意义

本项目的开发具有以下重要意义：

1. **技术实践价值**：通过实际项目开发，深入学习和实践Android现代开发技术栈，包括Jetpack Compose、Room数据库、MVVM架构等
2. **用户体验提升**：通过现代化的UI设计和流畅的交互体验，为用户提供优质的音乐播放服务
3. **功能完整性**：实现了从用户认证、音乐播放、数据管理到个性化设置的完整功能体系
4. **代码规范**：采用MVVM架构模式，代码结构清晰，便于维护和扩展
5. **学习价值**：为Android开发学习者提供了一个完整的项目参考案例

## 二、期末项目开发环境

本项目采用Kotlin语言及Android Jetpack组件库进行设计与开发，项目基于Jetpack Compose进行UI构建，采用MVVM架构模式进行代码组织，其软件开发环境为：

### 2.1 软件开发环境

1. **开发语言**：Kotlin 1.9.22
2. **开发工具**：Android Studio（推荐版本：Hedgehog或更高版本）
3. **Android SDK**：
   - 编译SDK版本：34（Android 14）
   - 最低支持SDK版本：24（Android 7.0）
   - 目标SDK版本：34
4. **构建工具**：Gradle 8.4.0
5. **Kotlin编译器扩展版本**：1.5.10

### 2.2 数据库管理系统

本项目数据库管理系统采用Room Persistence Library（基于SQLite），内设3个表，各表的结构如下：

#### 2.2.1 用户表（user_table）

用户表用于存储用户的基本信息，包括用户ID、昵称、用户名、密码、主题偏好、性别和最后登录时间。表结构如下：

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| id | INTEGER | PRIMARY KEY, AUTOINCREMENT | 用户唯一标识符 |
| nickname | TEXT | NOT NULL | 用户昵称 |
| username | TEXT | NOT NULL | 用户名（唯一，仅支持26个字母、数字、下划线） |
| password | TEXT | NOT NULL | 用户密码（SHA-256哈希存储） |
| darkMode | INTEGER | NOT NULL, DEFAULT 0 | 主题偏好（0=亮色，1=暗色） |
| gender | TEXT | NOT NULL, DEFAULT 'MALE' | 用户性别（MALE/FEMALE） |
| lastLoginTime | INTEGER | NULL | 最后登录时间（时间戳） |

#### 2.2.2 播放历史表（play_history）

播放历史表用于记录用户播放过的音乐信息，包括用户名、歌曲路径、歌曲名称和播放时间。表结构如下：

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| id | INTEGER | PRIMARY KEY, AUTOINCREMENT | 记录唯一标识符 |
| username | TEXT | NOT NULL | 用户名 |
| songPath | TEXT | NOT NULL | 歌曲文件路径 |
| songName | TEXT | NOT NULL | 歌曲名称 |
| playTime | INTEGER | NOT NULL | 播放时间（时间戳） |

#### 2.2.3 收藏音乐表（favorite_music）

收藏音乐表用于存储用户收藏的音乐信息，包括用户名、歌曲路径和歌曲名称。表结构如下：

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| id | INTEGER | PRIMARY KEY, AUTOINCREMENT | 记录唯一标识符 |
| username | TEXT | NOT NULL | 用户名 |
| songPath | TEXT | NOT NULL | 歌曲文件路径 |
| songName | TEXT | NOT NULL | 歌曲名称 |

**数据库版本管理**：本项目数据库当前版本为6，实现了5次数据库迁移（MIGRATION_1_2到MIGRATION_5_6），支持数据库结构的平滑升级。

### 2.3 第三方库包

本项目使用了以下主要第三方库和Android Jetpack组件：

1. **Jetpack Compose相关**：
   - `androidx.compose.ui:ui`：Compose UI核心库
   - `androidx.compose.material3:material3`：Material Design 3组件库
   - `androidx.compose.foundation:foundation`：Compose基础组件（用于HorizontalPager）
   - `androidx.activity:activity-compose`：Activity Compose支持

2. **架构组件**：
   - `androidx.lifecycle:lifecycle-viewmodel-compose`：ViewModel支持
   - `androidx.lifecycle:lifecycle-runtime-compose`：生命周期运行时支持
   - `androidx.navigation:navigation-compose`：导航组件

3. **数据持久化**：
   - `androidx.room:room-runtime`：Room数据库运行时库
   - `androidx.room:room-ktx`：Room Kotlin扩展
   - `androidx.room:room-compiler`：Room注解处理器（KSP）
   - `androidx.datastore:datastore-preferences`：DataStore偏好设置存储

4. **网络请求**：
   - `com.squareup.retrofit2:retrofit`：Retrofit网络请求库
   - `com.squareup.retrofit2:converter-gson`：Gson数据转换器
   - `com.squareup.okhttp3:logging-interceptor`：OkHttp日志拦截器

5. **图片加载**：
   - `io.coil-kt:coil-compose:2.5.0`：Coil图片加载库（Compose版本）

6. **文件访问**：
   - `androidx.documentfile:documentfile:1.0.1`：DocumentFile文件访问支持

7. **其他工具**：
   - `com.google.devtools.ksp`：Kotlin符号处理工具（用于Room注解处理）

## 三、期末项目成果演示

详细写出各功能模块的实现过程并截图。

### 3.1 启动页与用户认证系统

#### 3.1.1 启动页（SplashScreen）

启动页是应用启动时的第一个界面，主要功能是判断用户的登录状态并导航到相应的页面。实现逻辑如下：

1. **登录状态检查**：应用启动时，从DataStore中读取当前登录的用户名
2. **页面导航**：
   - 如果已登录，直接导航到主页面（MainScreen）
   - 如果未登录，导航到登录页面（LoginScreen）
3. **用户体验**：启动页显示应用Logo或加载动画，提升用户体验

**技术实现**：
- 使用`LaunchedEffect`在Compose中执行异步操作并在动画后跳转
- 使用DataStore读取登录状态，已登录用户自动跳转主页面（普通用户→`Main`，管理员→`AdminHome`）
- 使用Jetpack Navigation进行页面导航，启动页从回退栈移除避免返回时重复显示

**代码位置**：`ui/screen/SplashScreen.kt`（第27-80行）

#### 3.1.2 用户注册功能

用户注册功能允许新用户创建账户。注册界面包含以下功能：

1. **输入字段**：
   - 昵称输入框：用户可输入个性化昵称
   - 用户名输入框：用于登录的用户名
   - 密码输入框：用户密码（支持显示/隐藏）
   - 确认密码输入框：确认密码一致性

2. **用户名验证**：
   - 用户名仅支持26个字母（大小写）、数字和下划线
   - 使用正则表达式验证：`^[a-zA-Z0-9_]+$`
   - 实时验证，不符合规则时显示错误提示

3. **密码验证**：
   - 密码长度至少6位
   - 确认密码必须与密码一致

4. **注册流程**：
   - 验证所有输入字段的有效性
   - 检查用户名是否已存在
   - 密码使用SHA-256哈希算法加密存储
   - 注册成功后自动跳转到登录页面

**代码位置**：
- 注册页面：`ui/screen/RegisterScreen.kt`（第26-205行）
- 用户名验证：`ui/screen/RegisterScreen.kt`（第36-43行）
- 用户服务：`data/UserService.kt`（注册逻辑）

#### 3.1.3 用户登录功能

用户登录功能允许已注册用户登录系统。登录界面包含以下功能：

1. **输入字段**：
   - 用户名输入框
   - 密码输入框（支持显示/隐藏）

2. **登录验证**：
   - 验证用户名和密码是否匹配
   - 密码使用SHA-256哈希算法与数据库中的密码进行比对
   - 登录成功后更新用户的最后登录时间（lastLoginTime）

3. **用户权限判断**：
   - 普通用户：登录后进入用户主页（UserHomeScreen）
   - 管理员用户（username="admin"）：登录后进入管理员主页（AdminScreen）

4. **登录状态保存**：
   - 登录成功后，将用户名保存到DataStore
   - 下次启动应用时自动登录

**代码位置**：
- 登录页面：`ui/screen/LoginScreen.kt`（第28-214行）
- 登录逻辑：`data/UserService.kt`（第60-82行）
- 更新登录时间：`data/UserService.kt`（第82行）

**默认管理员账号**：
- 用户名：`admin`
- 密码：`admin123`

### 3.2 音乐播放功能

#### 3.2.1 音乐列表展示

音乐列表页面是用户浏览和管理本地音乐的主要界面，主要功能包括：

1. **音乐加载方式**：
   - **从系统媒体库加载**：使用`MediaStore.Audio.Media`查询设备上的所有音频文件
   - **从指定文件夹加载**：用户可以选择指定文件夹，使用`DocumentFile` API访问文件夹中的音乐文件
   - 文件夹URI保存在DataStore中，下次启动时自动加载

2. **音乐信息显示**：
   - 歌曲名称、艺术家名称、专辑名称、歌曲时长
   - 收藏状态（心形图标），实时反映收藏结果

3. **权限管理**：
   - Android 13+（API 33+）：使用`READ_MEDIA_AUDIO`权限
   - Android 12及以下：使用`READ_EXTERNAL_STORAGE`权限
   - 使用`rememberLauncherForActivityResult`动态申请权限

**代码位置**：
- 音乐列表页面：`ui/screen/UserHomeScreen.kt`（第48-474行）
- 从媒体库加载：`data/repository/MusicRepository.kt`（第32-66行）
- 从文件夹加载：`data/repository/MusicRepository.kt`（第68-78行）
- 权限申请：`ui/screen/UserHomeScreen.kt`（第67-87行）

#### 3.2.2 音乐播放服务（MusicService）

音乐播放服务是一个后台Service，使用`MediaPlayer`进行音乐播放，实现以下核心功能：

1. **播放控制方法**：
   - `playMusic(uri: Uri)`：播放指定URI的音乐
   - `pauseMusic()` / `resumeMusic()`：暂停或恢复播放
   - `playNext(fromCompletion: Boolean)` / `playPrevious()`：切换上下首
   - `seekTo(position: Int)`：跳转到指定播放位置

2. **播放模式**：
   - **SEQUENTIAL（顺序播放）**：按列表顺序播放
   - **SHUFFLE（随机播放）**：使用Fisher–Yates洗牌算法生成随机播放列表
   - **REPEAT_ONE（单曲循环）**：重复播放当前歌曲

3. **洗牌算法实现**：
   ```kotlin
   private fun shufflePlaylist() {
       shuffledPlaylist.clear()
       shuffledPlaylist.addAll(musicFiles.indices)
       for (i in shuffledPlaylist.size - 1 downTo 1) {
           val j = random.nextInt(i + 1)
           shuffledPlaylist[i] = shuffledPlaylist[j].also {
               shuffledPlaylist[j] = shuffledPlaylist[i]
           }
       }
   }
   ```

4. **线程安全与错误处理**：
   - 使用`synchronized(this)`封装MediaPlayer关键操作
   - 用`preparingUri`避免快速切歌导致的回调错乱
   - 完善的错误监听与日志记录

5. **播放进度更新**：
   - 使用`Handler`每秒推送进度
   - 通过`OnPlaybackStateChangeListener`接口通知UI同步

**代码位置**：
- 音乐服务：`service/MusicService.kt`（第21-517行）
- 播放控制：`playMusic()`（第97行）、`pauseMusic()`（第346行）、`playNext()`（第298行）、`playPrevious()`（第322行）、`seekTo()`（第364行）
- 播放模式枚举：`PlayMode`（第27行）
- 洗牌算法：`shufflePlaylist()`（第489-497行）

#### 3.2.3 播放页面（PlayerScreen）

播放页面提供全屏播放控制，包含：

1. **界面元素**：专辑封面、滚动歌曲名（`ScrollingTitle`）、进度条、播放控制按钮、播放模式按钮、播放列表按钮
2. **滚动标题**：当歌曲名过长时自动无缝滚动，正在播放时强制滚动
3. **播放列表气泡**：点击播放列表按钮在页面上方弹出气泡，背景半透明压暗，列表样式参考首页音乐列表；当前播放高亮并标注“正在播放”，点击可直接切歌
4. **收藏与播放统计**：播放页可直接“喜欢/取消喜欢”当前歌曲；展示当前歌曲累计播放次数（耳机图标），计数随每次播放递增
5. **播放模式切换**：顺序 → 随机 → 单曲循环循环切换，随机模式重建洗牌列表

**代码位置**：
- 播放页面：`ui/screen/PlayerScreen.kt`
- 滚动标题组件：`ui/component/ScrollingTitle.kt`（完整文件）
- 播放控制 / 播放列表 / 播放计数：`ui/viewmodel/PlayerViewModel.kt`
- 收藏切换与播放列表数据：`ui/viewmodel/UserViewModel.kt`
- 播放计数来源：`service/MusicService.kt`、`service/MusicServiceConnection.kt`